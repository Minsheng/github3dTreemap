<!DOCTYPE html>
<head>
	<meta charset="utf-8">
	<script src="./js/modernizr.min.js"></script>
	<script src="./js/lodash.min.js"></script>
	<script src="./js/three.min.js"></script>
	<script src="./js/TrackballControls.js"></script>
	<script src="./js/OrbitControls.js"></script>
	<script src="./js/CanvasRenderer.js"></script>
	<script src="../js/DragControls.js"></script>
	<script src="../js/ShadowMaterial.js"></script>
	<script src="./js/tween.js"></script>
	<script src="./js/d3.min.js"></script>
	<title>Github 3D Treemap</title>
	<style>
		body {
		  font-family: "Helvetica Neue", Helvetica, "Segoe UI", Arial;
		  margin: auto;
		  position: relative;
		  padding: 20px;
		  height: 100%;
		  color: #5CB3FF;
		  background-color: #424242;
		}

		h1 {
			color: #FFFFFF;
		}

		h2 {
			color: #BCC6CC;
		}

		.instructions {
			margin-bottom: 16px;
		}

		.color-ribbon {
			display: inline;
		}
	</style>
  
	<body>
	  <h1>3D Treemap - Github Contributions by Projects</h1>
	  <h2>by Davidson Zheng</h2>
	  <div class="instructions">(Mouse Left Key = Rotate; Mouse Right Key = Translate; Middle Wheel = Zoom In/Out)</div>
	  <div class="color-ribbon">
	  	<svg width="120" height="20">
		  <rect x="0" y="0" width="20" height="20" style="fill:#9c9ede;"/>
		  <rect x="24" y="0" width="20" height="20" style="fill:#cedb9c;"/>
		  <rect x="48" y="0" width="20" height="20" style="fill:#e7cb94;"/>
		  <rect x="72" y="0" width="20" height="20" style="fill:#e7969c;"/>
		  <rect x="96" y="0" width="20" height="20" style="fill:#de9ed6;"/>
		</svg>
		<span>These colors show different projects.</span>
	  </div>
	  <div id="container"></div>
	    <script type="text/javascript">
		    var DEBUG = 0;

		    demo = {};

			demo.Treemap3d = function() {

			    "use strict";

			    var _width          = 720,
			        _height         = 580,
			        _renderer       = null,
			        _controls       = null,
			        _scene          = new THREE.Scene(),
			        _camera         = new THREE.PerspectiveCamera(45, _width/_height , 1, 10000),
			        // assign color based on different names
			        _colorScale     = d3.scale.category20b(), 
			        _scaler     	= d3.scale.linear().domain([0, 10000]).range([0,1000]), // scale down the number
			        parentCells		= null,
			        childrenCells	= null,
			        _showLabels     = true,
			        _boxMap         = {};
			    
			    _scaler.clamp(true); // enable clamping
			    var parentColorSet = ["#0C090A", "#4C4646", "#565051", "#6D6968", "#E5E4E2"];
			    var root;
    			var node;

				var clock = new THREE.Clock();

			    function Treemap3d(selection) {
			        _camera.setLens(30);
			        _camera.position.set(0, 0, 3000);
			        _camera.lookAt(_scene.position);

			        _renderer = Modernizr.webgl ? new THREE.WebGLRenderer({antialias: false}) : new THREE.CanvasRenderer();
			        _renderer.setSize(_width, _height);
			        _renderer.setClearColor(0xFFFFFF);
			        _renderer.domElement.style.position = 'absolute';
			        _renderer.shadowMap.enabled = true;
			        _renderer.shadowMapSoft = true;
			        _renderer.shadowMap.type = THREE.PCFShadowMap;
			        _renderer.shadowMapAutoUpdate = true;
			        
			        selection.node().appendChild(_renderer.domElement);
			        
			        function enterHandler(d) {
			            var boxGeometry = new THREE.BoxGeometry(1,1,1);
			            var boxMaterial = new THREE.MeshLambertMaterial({color: assignColor(d)});
			            var box = new THREE.Mesh(boxGeometry, boxMaterial);
			            box.castShadow = true;
			            _boxMap[d.name] = box;
			            _scene.add(box);
			        }

			        /* Assign colors for parents and children nodes */
			        function assignColor(d) {
			        	var tier = getTier(d);

			        	if (tier == 4) {
			        		for (var key in _boxMap) {
			        			// if there are siblings, use the same color
			        			if (key == d.parent.name) {
			        				return _colorScale(key);
			        			}
			        		}
			        		return _colorScale(d.name);
			        	}

		        		return parentColorSet[tier-1];
			        }

			        /* Return the tier number in the master data list */
			        function getTier(d) {
			        	if (!d.parent) {
			        		return 1; // root node
			        	}
			        	if (!d.children) {
			        		return 4; // leaf node
			        	}

			        	if (d.parent) { // at least tier 2 nodes
			        		if (d.parent.parent) {
			        			return 3;
			        		}
			        		return 2;
			        	}
			        }
			        
			        function updateHandler(d) {
			            var duration = 1000; // duration for animation
			            var zvalue; // vertical position
			            var color;
			            var depth; // thickness of cube
			            var parentDepth = {1:-32, 2:-24, 3:-16};

			            if (d.children) { // parent nodes
			            	zvalue = parentDepth[getTier(d)]; // tier 3:-16, 2:-24, 1: -32
			            	depth = 1;
			            } else {
			            	zvalue = _scaler(d.commits);
			            	depth = zvalue;
			            }
			            
			            var box = _boxMap[d.name]; // get box by name
			            box.material.color.set(assignColor(d));
			            var newMetrics = {
			                x: d.x + (d.dx / 2) - _width / 2,
			                y: d.y + (d.dy / 2) - _height / 2,
			                z: zvalue / 2,
			                w: Math.max(0, d.dx-1),
			                h: Math.max(0, d.dy-1),
			                d: depth
			            };

			            // refer to http://sole.github.io/tween.js/examples/03_graphs.html for the animation Sinusoidal.In and Out
			            var coords = new TWEEN.Tween(box.position)
			                .to({x: newMetrics.x, y: newMetrics.y, z: newMetrics.z}, duration)
			                .easing(TWEEN.Easing.Sinusoidal.InOut)
			                .start();
			                
			            var dims = new TWEEN.Tween(box.scale)
			                .to({x: newMetrics.w, y: newMetrics.h, z: newMetrics.d}, duration)
			                .easing(TWEEN.Easing.Sinusoidal.InOut)
			                .start();
			                
			            var newRot = box.rotation;
			            var rotate = new TWEEN.Tween(box.rotation)
			                .to({x: newRot.x, y: newRot.y, z: newRot.z}, duration)
			                .easing(TWEEN.Easing.Sinusoidal.InOut)
			                .start();
			            
			            // to be notified at every modification
			            var update = new TWEEN.Tween(this)
			                .to({}, duration)
			                .onUpdate(_.bind(render, this))
			                .start();
			        }
			        
			        function exitHandler(d) {
			            var box = _boxMap[d.name];
			            _scene.remove(box);
			            delete _boxMap[d.name];
			        }
			        
			        function transform() {
			            TWEEN.removeAll();
			            parentCells.each(updateHandler);
			            childrenCells.each(updateHandler);
			        }
			        
			        function render() {
			        	
			            _renderer.render(_scene, _camera);
			        }
			        
			        function animate() {
			            requestAnimationFrame(animate);
			            TWEEN.update();
			            _controls.update( clock.getDelta() );
			        }
			            
			        Treemap3d.load = function(data) {
			            var treemap = d3.layout.treemap()
			                .size([_width, _height])
			                .sticky(true)
			                .value(function(d) { 
			                    return d.size;
			                });

			            node = root = data;

			            var nodes = treemap.nodes(root);

			            var children = nodes.filter(function(d) {
				            return !d.children;
				        });

				        var parents = nodes.filter(function(d) {
				            return d.children;
				        });

				        // process parent nodes
				        parentCells = selection.selectAll("div.parent") 
				            .data(parents, function(d) {
				                return "p-" + d.name;
				            });

			            var parentEnterTransition = parentCells.enter()
							.append("div")
			                .attr("class", "parent")
			                .each(enterHandler);

			            parentCells.exit().each(exitHandler).remove();

			            // process children nodes
			            childrenCells = selection.selectAll("div.child")
				            .data(children, function(d) {
				                return "c-" + d.name;
				            });

			            var childEnterTransition = childrenCells.enter()
							.append("div")
			                .attr("class", "child")
			                .each(enterHandler);

			            childrenCells.exit().each(exitHandler).remove();

			            // set the padding for each child
			            treemap
						    .padding([10, 10, 10, 10])
						    .nodes(node);
			                
			            render();
			            animate();
			            transform();
			        };
			        
			        var directionalLight = new THREE.DirectionalLight(0xFFFFFF, 1.0);
			        directionalLight.position.set(-1000, -2000, 4000);
			        _scene.add(directionalLight);
			        
			        // add subtle ambient lighting
			        var ambientLight = new THREE.AmbientLight(0x313131);
			        _scene.add(ambientLight);

			        // control settings
			        _controls = new THREE.TrackballControls(_camera, _renderer.domElement);
			        _controls.staticMoving  = true;
			        _controls.minDistance = 100;
			        _controls.maxDistance = 6000;
			        _controls.rotateSpeed = 1.5;
			        _controls.zoomSpeed = 1.5;
			        _controls.panSpeed = 0.5;
			        _controls.addEventListener('change', render);
			    }

			    return Treemap3d;
			};

			if (DEBUG) { // debug mode
				var testData = {"tier":1, "name":"p1", "children":[
					{
						"tier":2, "name":"p2a", "children":[
						{
							"tier":3, "name":"p3a", "children":[
							{
								"tier":4, "name":"c1","size":1, "commits":12000
							}, 
							{
								"tier":4, "name":"c2","size":1, "commits":40
							}]
						},
						{
							"tier":3, "name":"p3b", "children":[
							{
								"tier":4, "name":"c3","size":1, "commits":5743
							},
							{
								"tier":4, "name":"c4","size":1, "commits":2813
							}]
						},
						{
							"tier":3, "name":"p3e", "children":[
							{
								"tier":4, "name":"c9","size":1, "commits":2389
							},
							{
								"tier":4, "name":"c10","size":1, "commits":2110
							}]
						}]
					},
					{
						"tier":2, "name":"p2b", "children":[
						{
							"tier":3, "name":"p3c", "children":[
							{
								"tier":4, "name":"c5","size":1, "commits":200
							}]
						}]
					},
					{
						"tier":2, "name":"p2c", "children":[
						{
							"tier":3, "name":"p3d", "children":[
							{
								"tier":4, "name":"c6","size":1, "commits":9999
							},
							{
								"tier":4, "name":"c7","size":1, "commits":1000
							},
							{
								"tier":4, "name":"c8","size":1, "commits":3520
							}]
						}]
					}

				]};

				var treemap3d = demo.Treemap3d();
				var chart = d3.select("#container").append("div")
			    	.style("position", "relative")
			    	.call(treemap3d);
				
				treemap3d.load(testData);
			} else {
				var sample_url = "https://raw.githubusercontent.com/Minsheng/github3dTreemap/master/data/sample_format.json";
				var full_url_2 = "https://raw.githubusercontent.com/Minsheng/github3dTreemap/master/data/tree_data_2.json";
				var full_url_10 = "https://raw.githubusercontent.com/Minsheng/github3dTreemap/master/data/tree_data_10.json";
				d3.json(sample_url, function(error, data) {
					if (error) throw error;

					var treemap3d = demo.Treemap3d(); // function variable
					d3.select("#container").append("div")
				    	.style("position", "relative")
				    	.call(treemap3d);
				   treemap3d.load(data);
				});
			}
	    </script>
	</body>
</head>